name: Frontend Deployment Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKERFILE_PATH: Dockerfile
  SSH_PORT: 22
  CONTAINER_PORT: 80
  HOST_PORT: 55502
  DEPLOY_DIR: /opt/bebochka
  IMAGE_NAME: bebochka-frontend

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Validate SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        echo "SSH key validated successfully"
      env:
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

  test-connection:
    needs: validate
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || success() }}
    steps:
    - name: Test SSH connection
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{ env.SSH_PORT }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== SSH Connection Test ==="
          echo "Connection successful!"
          echo "Docker version: $(docker --version)"
          echo "Disk space: $(df -h)"
          echo "Existing containers:"
          docker ps -a
          echo "=== Test completed successfully ==="

  test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        
    - name: Build project
      run: |
        npm run build
        
    - name: Run tests (if available)
      run: |
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
          npm test
        else
          echo "No test script found, skipping tests"
        fi
      continue-on-error: true

  build:
    needs: [validate, test]
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.determine_tag.outputs.TAG }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Determine Docker tag
      id: determine_tag
      run: |
        if [ -n "$(git tag --points-at HEAD)" ]; then
          echo "TAG=$(git tag --points-at HEAD)" >> $GITHUB_OUTPUT
        else
          echo "TAG=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
        fi
        echo "Using tag: $TAG"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker buildx create --use
        docker buildx build \
          -f ${{ env.DOCKERFILE_PATH }} \
          -t ${{ env.IMAGE_NAME }}:${{ steps.determine_tag.outputs.TAG }} \
          -t ${{ env.IMAGE_NAME }}:latest \
          --platform linux/amd64 \
          --load \
          .

    - name: Save Docker image
      run: |
        docker save ${{ env.IMAGE_NAME }}:latest | gzip > ${{ env.IMAGE_NAME }}.tar.gz

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: ${{ env.IMAGE_NAME }}.tar.gz
        retention-days: 1

  deploy:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download Docker image artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: .

    - name: Prepare deployment directory
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        script: |
          mkdir -p ${{ env.DEPLOY_DIR }}/frontend

    - name: Copy Docker image to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        source: "${{ env.IMAGE_NAME }}.tar.gz"
        target: "/tmp/"

    - name: Deploy application
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        envs: CONTAINER_PORT,HOST_PORT,IMAGE_NAME,DEPLOY_DIR
        script: |
          #!/bin/bash
          set -euo pipefail

          # Load Docker image
          echo "Loading Docker image..."
          docker load < /tmp/$IMAGE_NAME.tar.gz
          rm /tmp/$IMAGE_NAME.tar.gz

          # Stop existing container
          docker stop $IMAGE_NAME || true
          docker rm $IMAGE_NAME || true

          # Stop any container using port 80
          echo "Checking for containers using port $HOST_PORT..."
          EXISTING_CONTAINER=$(docker ps -q -f publish=$HOST_PORT)
          if [ -n "$EXISTING_CONTAINER" ]; then
            echo "Stopping container using port $HOST_PORT: $EXISTING_CONTAINER"
            docker stop $EXISTING_CONTAINER || true
            docker rm $EXISTING_CONTAINER || true
          fi

          # Run new container
          docker run -d \
            --name $IMAGE_NAME \
            --restart unless-stopped \
            -p $HOST_PORT:$CONTAINER_PORT \
            $IMAGE_NAME:latest

          # Clean up old images
          docker image prune -f

          echo "=== Deployment successful ==="
      env:
        CONTAINER_PORT: ${{ env.CONTAINER_PORT }}
        HOST_PORT: ${{ env.HOST_PORT }}
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
        DEPLOY_DIR: ${{ env.DEPLOY_DIR }}

  post-deploy-test:
    needs: [deploy, test-connection]
    runs-on: ubuntu-latest
    steps:
    - name: Verify deployment
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        script: |
          echo "=== Deployment Verification ==="
          echo "Container status:"
          docker ps -a | grep ${{ env.IMAGE_NAME }} || echo "Container not found"
          echo ""
          echo "Container logs (last 50 lines):"
          docker logs --tail 50 ${{ env.IMAGE_NAME }} || echo "Could not retrieve logs"
          echo ""
          echo "Checking frontend health..."
          sleep 5
          curl -f http://localhost:${{ env.HOST_PORT }}/ || echo "Frontend health check failed"
          echo ""
          echo "=== Verification completed ==="

